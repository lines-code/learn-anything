# ì•ˆì • í•´ì‹œ ì„¤ê³„ 

ìˆ˜í‰ì  ê·œëª¨ í™•ìž¥ì„±ì„ ë‹¬ì„±í•˜ê¸° ìœ„í•´ì„œëŠ” ìš”ì²­ ë˜ëŠ” ë°ì´í„°ë¥¼ ì„œë²„ì— ê· ë“±í•˜ê²Œ ë‚˜ëˆ„ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤. 

## í•´ì‹œ í‚¤ ìž¬ë°°ì¹˜(rehash) ë¬¸ì œ 

Nê°œì˜ ìºì‹œì„œë²„ê°€ ìžˆë‹¤ê³  í• ë•Œ, ì„œë²„ë“¤ì´ ë¶€í•˜ë¥¼ ê· ë“±í•˜ê²Œ ë‚˜ëˆ„ëŠ” ë³´íŽ¸ì ì¸ ë°©ë²•ì€ ì•„ëž˜ì˜ í•´ì‹œ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤. 

```
serverIndex = hash(key) % N (Nì€ ì„œë²„ì˜ ê°œìˆ˜)
```

ë§Œì•½ ì„œë²„ì˜ ê°œìˆ˜ê°€ 4ëŒ€ë¼ë©´, ì„œë²„ 0, 1, 2, 3ì— ê°ê° í‚¤ë¥¼ í• ë‹¹í•  ìˆ˜ ìžˆë‹¤.   
í•˜ì§€ë§Œ ì„œë²„ì˜ í•œëŒ€ì— ë¬¸ì œê°€ ë°œìƒí•˜ì—¬ ì„œë²„ê°€ ë‹¤ìš´ë˜ê±°ë‚˜, ì„œë²„ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì œê±°í•˜ëŠ” ê²½ìš°, í•´ì‹œ í‚¤ë¥¼ ìž¬ë°°ì¹˜í•´ì•¼ í•œë‹¤.   

ì´ë•Œ í•´ì‹œí‚¤ê°€ ìž¬ë°°ì¹˜ê°€ ë°œìƒí•˜ê²Œ ë˜ê³ , ëŒ€ë¶€ë¶„ì´ ìºì‹œ í´ë¼ì´ì–¸íŠ¸ëŠ” ë°ì´í„°ê°€ ì—†ëŠ” ì—‰ëš±í•œ ì„œë²„ì— ì ‘ì†í•˜ê²Œ ë˜ëŠ”ë°, ì´ëŠ” ê²°êµ­ ëŒ€ê·œëª¨ ìºì‹œ ë¯¸ìŠ¤ë¡œ ë°œìƒí•  ìˆ˜ ìžˆë‹¤. 


## ì•ˆì • í•´ì‹œ  

- ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ë°ì´í„°ì˜ ê· í˜• ìžˆëŠ” ë¶„ì‚°ê³¼ ë…¸ë“œ ë³€ê²½ ì‹œ ìµœì†Œí•œì˜ ìž¬ë°°ì¹˜ë¥¼ ë³´ìž¥

í•´ì‹œ í…Œì´ë¸”ì˜ í¬ê¸°ê°€ ì¡°ì •ë  ë•Œ í‰ê· ì ìœ¼ë¡œ ì˜¤ì§ k/n ê°œì˜ í‚¤ë§Œ ìž¬ë°°ì¹˜í•˜ëŠ” í•´ì‹œ ê¸°ìˆ ì´ë‹¤.  
ì—¬ê¸°ì„œ këŠ” í‚¤ì˜ ê°œìˆ˜ì´ê³ , nì€ ìŠ¬ë¡¯ì˜ ê°œìˆ˜ë‹¤.

### í•´ì‹œ ê³µê°„ê³¼ í•´ì‹œ ë§ 

- í•´ì‹œ í•¨ìˆ˜ fë¡œ SHA-1ì„ ì‚¬ìš©í•œë‹¤ê³  í•˜ê³ ,
  - ê·¸ í•¨ìˆ˜ì˜ ì¶œë ¥ ê°’ ë²”ìœ„ëŠ” x0, x1, ..., xN ì´ë¼ê³  í•˜ìž. 
  - SHA-1ì˜ ì¶œë ¥ ê°’ì€ 0ì—ì„œ 2^160-1ê¹Œì§€ì˜ ì •ìˆ˜ê°’ì„ ê°€ì§„ë‹¤.
  - x0ëŠ” 0, x1ì€ 2^160-1ê¹Œì§€ì˜ ì •ìˆ˜ê°’ì„ ê°€ì§„ë‹¤.
- í•´ì‹œ ë§ì€ í•´ì‹œ í•¨ìˆ˜ì˜ ì¶œë ¥ ê°’ ë²”ìœ„ë¥¼ ì›í˜•ìœ¼ë¡œ ì—°ê²°í•œ ê²ƒì´ë‹¤. 
  - ì¦‰, x0ì—ì„œ x1ê¹Œì§€ì˜ ê°’ì´ ì—°ê²°ë˜ì–´ ìžˆëŠ” êµ¬ì¡°ë‹¤. 
  - ì´ ë§ì€ 0ì—ì„œ 2^160-1ê¹Œì§€ì˜ ì •ìˆ˜ê°’ì„ ê°€ì§„ë‹¤.

### í•´ì‹œ ì„œë²„ 

- í•¨ìˆ˜ fë¥¼ ì‚¬ìš©í•˜ë©´ ì„œë²„ IPë‚˜ ì´ë¦„ì„ ì´ ë§ ìœ„ì˜ ì–´ë–¤ ìœ„ì¹˜ì— ëŒ€ì‘ì‹œí‚¬ ìˆ˜ ìžˆë‹¤. 

### í•´ì‹œ í‚¤

- "í•´ì‹œ í‚¤ ìž¬ë°°ì¹˜ ë¬¸ì œ"ì— ì–¸ê¸‰ëœ í•¨ìˆ˜ì™€ ë‹¤ë¥´ë©°, "ë‚˜ë¨¸ì§€ ì—°ì‚° %ëŠ” ì‚¬ìš©í•˜ì§€ ì•Šê³  ìžˆìŒ"ì— ìœ ì˜í•˜ìž 

#### ì„œë²„ ì¶”ê°€ ì‹œ

- ì„œë²„ ì¶”ê°€ì‹œ í•´ì‹œ ë§ì—ì„œ ë³´ê²Œ ë˜ë©´ ì‹¤ì œ ì„œë²„ 4ê°€ ì¶”ê°€ëœ ì‹œì ì— 
  - ì„œë²„ 0, 1, 2, 3ì˜ ìœ„ì¹˜ê°€ ë³€ê²½ë˜ì§€ ì•Šê³ , 
  - ì„œë²„ 4ì˜ ìœ„ì¹˜ê°€ ì¶”ê°€ëœë‹¤.
  - ì´ë•Œ k0ì´ ì„œë²„ 0ì— í• ë‹¹ë˜ì—ˆë‹¤ë©´,
  - k0ì€ ì„œë²„ 4ê°€ ì¶”ê°€ë˜ì—ˆì„ë•Œ, ì‹œê³„ë°©í–¥ìœ¼ë¡œ ìˆœíšŒí–ˆì„ ë•Œ ì²˜ìŒ ë§Œë‚˜ê²Œ ë˜ëŠ” ì„œë²„ì¸ ì„œë²„ 4ì— í• ë‹¹ë˜ê²Œ ëœë‹¤. 

#### ì„œë²„ ì œê±° ì‹œ 

- ì„œë²„ ì œê±° ì‹œ í•´ì‹œ ë§ì—ì„œ ë³´ê²Œ ë˜ë©´ ì‹¤ì œ ì„œë²„ 4ê°€ ì œê±°ëœ ì‹œì ì— 
  - ì„œë²„ 0, 1, 2, 3ì˜ ìœ„ì¹˜ê°€ ë³€ê²½ë˜ì§€ ì•Šê³ , 
  - ì„œë²„ 4ì˜ ìœ„ì¹˜ê°€ ì œê±°ëœë‹¤.
  - ì´ë•Œ k0ì´ ì„œë²„ 4ì— í• ë‹¹ë˜ì–´ ìžˆë‹¤ê°€, 
  - k0ì€ ì„œë²„ 4ê°€ ì œê±°ë˜ì—ˆì„ë•Œ, ì‹œê³„ë°©í–¥ìœ¼ë¡œ ìˆœíšŒí–ˆì„ ë•Œ ì²˜ìŒ ë§Œë‚˜ê²Œ ë˜ëŠ” ì„œë²„ì¸ ì„œë²„ 3ì— í• ë‹¹ë˜ê²Œ ëœë‹¤.

### ì•ˆì •í•´ì‹œì—ì„œ ê· ë“± ë¶„í¬ë¥¼ ë‹¬ì„±í•˜ê¸° ì–´ë ¤ì›€ìœ¼ë¡œ ì¸í•´ì„œ ê°€ìƒ ë…¸ë“œë¥¼ í™œìš©

- í•´ì‹œ ë§ì—ì„œ ì„œë²„ì˜ ìœ„ì¹˜ê°€ ê· ë“±í•˜ê²Œ ë¶„í¬ë˜ì§€ ì•ŠëŠ” ê²½ìš°ê°€ ë°œìƒí•  ìˆ˜ ìžˆë‹¤.
- ì´ëŸ° ê²½ìš°ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ ê°€ìƒ ë…¸ë“œë¥¼ í™œìš©í•œë‹¤.
- ê°€ìƒ ë…¸ë“œëŠ” ì‹¤ì œ ì„œë²„ì˜ ìœ„ì¹˜ë¥¼ ì—¬ëŸ¬ ê°œë¡œ ë‚˜ëˆ„ì–´, í•´ì‹œ ë§ì—ì„œ ê· ë“±í•˜ê²Œ ë¶„í¬ë˜ë„ë¡ í•œë‹¤.
- ê° ì„œë²„ëŠ” ê°€ìƒë…¸ë“œë¥¼ ì´ìš©í•´ì„œ ì—¬ëŸ¬ íŒŒí‹°ì…˜ì„ í™œìš©í•  ìˆ˜ ìžˆê²Œ ëœë‹¤. 

## ì•ˆì • í•´ì‹œì˜ ì´ì  

- ì„œë²„ê°€ ì¶”ê°€ë˜ê±°ë‚˜ ì‚­ì œë  ë•Œ ìž¬ë°°ì¹˜ë˜ëŠ” í‚¤ì˜ ìˆ˜ê°€ ìµœì†Œí™” ëœë‹¤. 
- ë°ì´í„°ê°€ ë³´ë‹¤ ê· ë“±í•˜ê³  ë¶„í¬í•˜ê²Œ ë˜ë¯€ë¡œ ìˆ˜í‰ì  ê·œëª¨ í™•ìž¥ì„±ì„ ë‹¬ì„±í•˜ê¸° ì‰½ë‹¤. 
- ì„œë²„ì˜ ì¶”ê°€ë‚˜ ì‚­ì œê°€ ë°œìƒí•´ë„, ì „ì²´ ì‹œìŠ¤í…œì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì´ ìµœì†Œí™”ëœë‹¤.

# ì˜ˆì‹œ ìƒ˜í”Œ 

```python
import hashlib
import bisect

class ConsistentHashRing:
    def __init__(self, nodes=None, replicas=3):
        self.replicas = replicas  # ê°€ìƒ ë…¸ë“œ ìˆ˜
        self.ring = dict()
        self.sorted_keys = []

        if nodes:
            for node in nodes:
                self.add_node(node)

    def _hash(self, key):
        """SHA-256 í•´ì‹œ í•¨ìˆ˜ (ì •ìˆ˜ë¡œ ë³€í™˜)"""
        return int(hashlib.sha256(key.encode('utf-8')).hexdigest(), 16)

    def add_node(self, node):
        """ë…¸ë“œ ì¶”ê°€ (ê°€ìƒ ë…¸ë“œ í¬í•¨)"""
        for i in range(self.replicas):
            virtual_node_key = f"{node}#{i}"
            hash_key = self._hash(virtual_node_key)
            self.ring[hash_key] = node
            bisect.insort(self.sorted_keys, hash_key)

    def remove_node(self, node):
        """ë…¸ë“œ ì œê±°"""
        for i in range(self.replicas):
            virtual_node_key = f"{node}#{i}"
            hash_key = self._hash(virtual_node_key)
            self.ring.pop(hash_key, None)
            self.sorted_keys.remove(hash_key)

    def get_node(self, key):
        """í‚¤ê°€ ë§¤í•‘ë  ë…¸ë“œ ë°˜í™˜"""
        if not self.ring:
            return None
        hash_key = self._hash(key)
        index = bisect.bisect(self.sorted_keys, hash_key) % len(self.sorted_keys)
        return self.ring[self.sorted_keys[index]]


# ðŸŒ í…ŒìŠ¤íŠ¸
if __name__ == "__main__":
    ring = ConsistentHashRing(nodes=["NodeA", "NodeB", "NodeC"])

    # í‚¤ í• ë‹¹ ì˜ˆì‹œ
    keys = ["apple", "banana", "grape", "lemon", "cherry"]
    for key in keys:
        node = ring.get_node(key)
        print(f"{key} --> {node}")
    # ë…¸ë“œ ì¶”ê°€ í›„ ìž¬ë°°ì¹˜ í™•ì¸
    print("\n[Add NodeD]")
    ring.add_node("NodeD")
    for key in keys:
        node = ring.get_node(key)
        print(f"{key} --> {node}")

    # ë…¸ë“œ ì œê±° í›„ ìž¬ë°°ì¹˜ í™•ì¸
    print("\n[Remove NodeB]")
    ring.remove_node("NodeB")
    for key in keys:
        node = ring.get_node(key)
        print(f"{key} --> {node}")

```
